{% extends "dtd_request/base.html" %}

{% load static %}

{% block title %}Enter a New Call{% endblock %}

{% block content %}

<div class="container p-2 bg-light">
  <form action="{% url 'dtd_calls:call_update' call.id %}" method="post">
    {% csrf_token %}

    
    <!--Non Field Errors-->
    <div class="row">
      <div class="col-12">
        {{ form.non_field_errors }}
      </div>
    </div>

    <!--Row 1, Caller Number, Caller Email Address-->
    <div class="row py-2">
      <div class="col-sm-6">
        <div class="form-group">
          {{ form.caller_number.label_tag }}
          {{ form.caller_number }}
          <small class="form-text text-muted">{{ form.caller_number.help_text|safe }}</small>
          <div class="text-danger">
            {{ form.caller_number.errors }}
          </div>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="form-group">
          {{ form.caller_email.label_tag }}
          {{ form.caller_email }}
          <small class="form-text text-muted">{{ form.caller_email.help_text|safe }}</small>
          <div class="text-danger">
            {{ form.caller_email.errors }}
          </div>
        </div>
      </div>
    </div>

    <!--Row 2, Caller Name, Address-->
    <div class="row py-2">
      <div class="col-sm-4">
        <div class="form-group">
          {{ form.caller_name.label_tag }}
          {{ form.caller_name }}
          <small class="form-text text-muted">{{ form.caller_name.help_text|safe }}</small>
          <div class="text-danger">
            {{ form.caller_name.errors }}
          </div>
        </div>
      </div>
      <div class="col-sm-8">
        <div class="form-group">
          {{ form.caller_address.label_tag }}
          {{ form.caller_address }}
          <small class="form-text text-muted">{{ form.caller_address.help_text|safe }}</small>
          <div class="text-danger">
            {{ form.caller_address.errors }}
          </div>
        </div>
      </div>
    </div>

    <!--Row 3, Caller City, State, Zip-->
    <div class="row py-2">
      <div class="col-sm-6">
        <div class="form-group">
          {{ form.caller_city.label_tag }}
          {{ form.caller_city }}
          <small class="form-text text-muted">{{ form.caller_city.help_text|safe }}</small>
          <div class="text-danger">
            {{ form.caller_city.errors }}
          </div>
        </div>
      </div>
      <div class="col-sm-2">
        <div class="form-group">
          {{ form.caller_state.label_tag }}
          {{ form.caller_state }}
          <small class="form-text text-muted">{{ form.caller_state.help_text|safe }}</small>
          <div class="text-danger">
            {{ form.caller_state.errors }}
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="form-group">
          {{ form.caller_zip.label_tag }}
          {{ form.caller_zip }}
          <small class="form-text text-muted">{{ form.caller_zip.help_text|safe }}</small>
          <div class="text-danger">
            {{ form.caller_zip.errors }}
          </div>
        </div>
      </div>
    </div>

    <!--Row 4, Caller DOB, Caller Age, Gender, Household Size-->
    <div class="row py-2">
      <div class="col-sm-3">
        <div class="form-group">
          {{ form.caller_dob.label_tag }}
          <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
            {{ form.caller_dob }}
            <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
                <div class="input-group-text">
                  <img src="{% static 'dtd_request/icons/svg/calendar.svg' %}" class="img-fluid" style="width:1.5em;height:1.3rem;" alt="Pick Date">
                </div>
            </div>
          </div>
          <div class="text-danger">
            {{ form.caller_dob.errors }}
          </div>
        </div>
      </div>

      <div class="col-sm-3">
        <div class="form-group">
          {{ form.caller_age.label_tag }}
          {{ form.caller_age }}
          <div class="text-danger">
            {{ form.caller_age.errors }}
          </div>
        </div>
      </div>

      <div class="col-sm-3">
        <div class="form-group">
          {{ form.caller_gender.label_tag }}
          {{ form.caller_gender }}
          <div class="text-danger">
            {{ form.caller_gender.errors }}
          </div>
        </div>
      </div>

      <div class="col-sm-3">
        <div class="form-group">
          {{ form.caller_household_size.label_tag }}
          {{ form.caller_household_size }}
          <div class="text-danger">
            {{ form.caller_household_size.errors }}
          </div>
        </div>
      </div>
    </div>

    <!--Row 5, 3 Columns-->
    <div class="row py-2">

      <!-- Call Notes -->
      <div class="col-sm-4">
        <div class="form-group">
          {{ form.notes.label_tag }}
          {{ form.notes }}
          <div class="text-danger">
            {{ form.notes.errors }}
          </div>
        </div>
      </div>

      <!--Col1, Call Type, Covid-Related, Client Referred, Referral ID, Referral Agency-->
      <div class="col-sm-4">
        <div class="form-group">
          {{ form.call_type.label_tag }}
          {{ form.call_type }}
          <div class="text-danger">
            {{ form.call_type.errors }}
          </div>
        </div>

        <div class="form-group">
          {{ form.covid_related.label_tag }}
          {{ form.covid_related }}
          <div class="text-danger">
            {{ form.covid_related.errors }}
          </div>
        </div>

        <div class="form-group">
          {{ form.client_referred.label_tag }}
          {{ form.client_referred }}
          <div class="text-danger">
            {{ form.client_referred.errors }}
          </div>
        </div>

        <div class="form-group">
          {{ form.referral_id.label_tag }}
          {{ form.referral_id }}
          <div class="text-danger">
            {{ form.referral_id.errors }}
          </div>
        </div>

        <div class="form-group">
          {{ form.referred_agency.label_tag }}
          {{ form.referred_agency }}
          <div class="text-danger">
            {{ form.referred_agency.errors }}
          </div>
        </div>

        <!-- 'Other' agency option -->
        <div class="form-group">
          <input 
            type="text"
            name="other-agency"
            id="otherAgency"
            class="form-control"
            placeholder="Agency Name"
            hidden>
        </div>
      </div>

      <!-- Update Notes -->
      <div class="col-sm-4">
        {{ status.management_form }}
        {% for form in status.forms %}
          {% if forloop.first %}
            <div class="row">
              <div class="col-12 pb-2">
                Current Status:
              </div>
            </div>
          {% endif %}
          {% for field in form.visible_fields %}
          {% if forloop.first %}{% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}{% endif %}
            <div class="row form-row">
              <div class="col-12">
                <div class="input-group mb-3">
                  {{ field }}
                </div>
              </div>
            </div>
          {% endfor %}
        {% endfor %}

        <div class="form-group">
          <div class="form-group">
            <label for="lastUpdatedBy">Last Updated By</label>
            <input type="text" class="form-control" id="lastUpdatedBy" readonly value="{{ call.status.updated_by }}">
          </div>
        </div>

        <div class="form-group">
          {{ form.assigned_to.label_tag }}
          {{ form.assigned_to }}
          <div class="text-danger">
            {{ form.assigned_to.errors }}
          </div>
        </div>

        <div class="form-group">
          {{ form.followup_notes.label_tag }}
          {{ form.followup_notes }}
          <div class="text-danger">
            {{ form.followup_notes.errors }}
          </div>
        </div>
      </div>
    </div>

    <div class="row d-flex justify-content-center">
      <div class="col-4 text-center">
        <input type="submit" value="Update Call Information" class="btn btn-primary" id="submitBtn">
      </div>
    </div>
  </form>
</div>

<!-- Script for 'Other' Agency Option -->
<script>
  $(function() {
    $("#{{ form.referral_id.auto_id }}").prop('readonly', true).prop('required', false);
    $("#{{ form.referred_agency.auto_id }}").prop('disabled', true).prop('required', false);
  });

  $("#{{ form.client_referred.id_for_label }}").on("click", function () { 
    if ($(this).prop("checked")==true) {
      $("#{{ form.referral_id.id_for_label }}").prop('readonly', false).prop('required', true); 
      $("#{{ form.referred_agency.auto_id }}").prop('disabled', false).prop('required', true);
    } else {
      $("#{{ form.referral_id.id_for_label }}").prop('readonly', true).prop('required', false).val("");
      $("#{{ form.referred_agency.auto_id }}").prop('disabled', true).prop('required', false).val("");
    }
  });

  $('#{{form.referred_agency.auto_id}}').change(function() {    
    var item=$(this);
    var selected = item.val();
    if (selected == 1) {
      $("#otherAgency").removeAttr('hidden').attr('required', true);
    } else {
      $("#otherAgency").removeAttr('required').attr('hidden', true).val("");
    }
  });
</script>

<!-- Set Defaults for some Form Fields -->
<script>
  $(function() {
    $("#{{ form.notes.auto_id }}").prop('readonly', true);
    $(".call-status").val("{{ call.status.status }}")
  })
</script>

{% endblock %}